<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food Ingredient AI Analysis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg-color: #f8fafc;
      --card-bg: rgba(255, 255, 255, 0.75);
      --card-border: rgba(255, 255, 255, 0.8);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --radius: 20px;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .dark {
      color-scheme: dark;
      --bg-color: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: rgba(255, 255, 255, 0.1);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    body {
      margin: 0;
      font-family: var(--font-sans);
      color: var(--text-main);
      background-color: var(--bg-color);
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      padding: 30px 40px;
    }

    header {
      margin-bottom: 32px;
      text-align: center;
      position: relative;
    }

    .theme-switch {
      position: absolute;
      top: 0;
      right: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 99px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--card-border);
    }

    h1 {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      align-items: start;
    }

    @media (min-width: 1200px) {
      .main-grid {
        grid-template-columns: 400px 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 24px;
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* æ‹æ”æé†’ */
    .upload-tip {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .btn {
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-main);
    }

    .results-stack {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ä¸¦æ’å€åŸŸ */
    .results-top-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    @media (min-width: 900px) {
      .results-top-row {
        grid-template-columns: 1fr 1fr;
      }
    }

    .notes-box {
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.15);
      border-radius: 16px;
      padding: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
    }

    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      font-size: 14px;
    }

    /* é¡è‰²æ¨™ç±¤ */
    .pill {
      padding: 2px 10px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 700;
      display: inline-block;
    }

    .pill.ok {
      color: var(--success);
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .pill.warn {
      color: var(--warning);
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .pill.bad {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: rgba(0, 0, 0, 0.03);
      padding: 12px;
      text-align: left;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    td {
      padding: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.04);
      font-size: 14px;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-main);
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      resize: vertical;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div id="themeToggle" class="theme-switch">
        <span id="themeIcon">ğŸŒ™</span> <span id="themeText">åˆ‡æ›æ·±è‰²</span>
      </div>
      <h1>é£Ÿå“æˆåˆ† AI åˆ†æ</h1>
    </header>

    <div class="main-grid">
      <section class="card">
        <div class="section-header"><span class="section-title">ğŸ“· åœ–ç‰‡ä¸Šå‚³</span></div>
        <div class="upload-tip">
          ğŸ’¡ <b>æ‹æ”å»ºè­°ï¼š</b><br>
          â€¢ åƒ…æ‹æ”ã€Œæˆåˆ†èˆ‡ç‡Ÿé¤Šæ¨™ç¤ºã€å€åŸŸ<br>
          â€¢ ä¿æŒåŒ…è£<b>å¹³æ•´ã€æ¸…æ™°ã€ä¸åå…‰</b>
        </div>
        <input id="file" type="file" accept="image/*" style="width: 100%;" />
        <div class="btn-group">
          <button id="btnAnalyze" class="btn btn-primary" disabled>é–‹å§‹åˆ†æ</button>
          <button id="btnClear" class="btn btn-secondary">æ¸…é™¤é‡è¨­</button>
        </div>
        <div id="banner" style="display:none; margin-top:15px; font-weight:600; font-size:14px;"></div>
        <div id="preview" style="margin-top: 20px; text-align: center;">
          <img id="previewImg" style="max-width: 100%; border-radius: 12px; display: none;" />
        </div>
      </section>

      <div class="results-stack">
        <div class="results-top-row">
          <div class="notes-box">
            <div class="section-header"><span class="section-title">âœ¨ å¥åº·åˆ†ææ‘˜è¦</span></div>
            <div class="kv">
              <div>ç´ åˆ¥åˆ¤æ–·</div>
              <div><span id="dietaryCategory" class="pill">å°šç„¡è³‡æ–™</span></div>
              <div>åˆ¤æ–·ä¾æ“š</div>
              <div id="dietaryReason">å°šç„¡è³‡æ–™</div>
            </div>
            <p id="overallSummary" style="margin-top:15px; font-size:14px;">ç­‰å¾…åˆ†æçµæœ...</p>
          </div>

          <div class="notes-box">
            <div class="section-header"><span class="section-title">ğŸ“ AI ç­†è¨˜äº‹é …</span></div>
            <ul id="notes" style="font-size:14px; padding-left:20px; margin:0;">
              <li>å°šç„¡è³‡æ–™</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <div class="section-header"><span class="section-title">âš ï¸ æ·»åŠ ç‰©è­¦ç¤ºæ¸…å–® (ç´…/é»ƒ/ç¶ ç‡ˆ)</span></div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>æˆåˆ†åç¨±</th>
                  <th>é¢¨éšªç­‰ç´š</th>
                  <th>èªªæ˜</th>
                </tr>
              </thead>
              <tbody id="additivesAlerts">
                <tr>
                  <td colspan="3" style="text-align:center;">å°šç„¡è³‡æ–™</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="section-header"><span class="section-title">ğŸ“Š ç‡Ÿé¤Šå»ºè­°</span></div>
          <div class="kv">
            <div>ç‡Ÿé¤Šæ¨™ç¤º</div>
            <div id="nutritionDetected">å°šç„¡è³‡æ–™</div>
            <div>ç†±é‡</div>
            <div id="caloriesPerServing">å°šç„¡è³‡æ–™</div>
            <div>éˆ‰è­¦å‘Š</div>
            <div><span id="sodiumWarning" class="pill">å°šç„¡è³‡æ–™</span></div>
            <div>ç³–è­¦å‘Š</div>
            <div><span id="sugarWarning" class="pill">å°šç„¡è³‡æ–™</span></div>
          </div>
          <p id="nutritionAdvice" style="margin-top:15px; font-size:14px;">å°šç„¡è³‡æ–™</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <div class="card">
            <div class="section-header"><span class="section-title">ğŸ” ä¸»è¦æˆåˆ†</span></div>
            <ul id="ingredients" style="font-size:14px; padding-left:20px; margin:0;">
              <li>å°šç„¡è³‡æ–™</li>
            </ul>
          </div>
          <div class="card">
            <div class="section-header" style="color:var(--danger)"><span class="section-title">ğŸš« éæ•åŸ</span></div>
            <ul id="allergens" style="font-size:14px; padding-left:20px; margin:0;">
              <li>å°šç„¡è³‡æ–™</li>
            </ul>
          </div>
        </div>

        <details class="card">
          <summary style="cursor:pointer; font-size:13px; color:var(--text-muted);">åŸå§‹è¾¨è­˜æ–‡å­— (OCR)</summary>
          <textarea id="ocrText" readonly style="margin-top:10px;"></textarea>
        </details>
      </div>
    </div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const html = document.documentElement;

    // ä¸»é¡Œåˆ‡æ›
    const updateTheme = (isDark) => {
      html.classList.toggle('dark', isDark);
      el('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      el('themeText').textContent = isDark ? 'åˆ‡æ›æ·ºè‰²' : 'åˆ‡æ›æ·±è‰²';
    };
    el('themeToggle').onclick = () => {
      const isDark = !html.classList.contains('dark');
      updateTheme(isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    updateTheme(localStorage.getItem('theme') === 'dark');

    // é¡è‰²åˆ¤å®šé‚è¼¯ (ç´…é»ƒç¶ )
    const getRiskClass = (text) => {
      const s = String(text || '').toLowerCase();
      if (s.includes('é«˜') || s.includes('ç´…') || s.includes('high')) return 'bad';
      if (s.includes('ä¸­') || s.includes('é»ƒ') || s.includes('medium') || s.includes('warn')) return 'warn';
      if (s.includes('ä½') || s.includes('ç¶ ') || s.includes('low') || s.includes('ok')) return 'ok';
      return '';
    };

    const file = el('file');
    const btnAnalyze = el('btnAnalyze');
    const banner = el('banner');

    file.onchange = () => {
      if (file.files[0]) {
        el('previewImg').src = URL.createObjectURL(file.files[0]);
        el('previewImg').style.display = 'inline-block';
        btnAnalyze.disabled = false;
      }
    };

    el('btnClear').onclick = () => location.reload();

    btnAnalyze.onclick = async () => {
      btnAnalyze.disabled = true;
      btnAnalyze.textContent = 'åˆ†æä¸­...';
      banner.style.display = 'block';
      banner.innerHTML = '<span style="color:var(--warning)">â³ AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...</span>';

      try {
        const fd = new FormData();
        fd.append('image', file.files[0]);
        const resp = await fetch('/analyze', { method: 'POST', body: fd });
        const data = await resp.json();

        if (resp.ok && data.llm?.json) {
          const j = data.llm.json;
          el('ocrText').value = data.ocr.full_text;

          // æ‘˜è¦èˆ‡ç´ åˆ¥
          el('dietaryCategory').textContent = j.dietary_category;
          el('dietaryCategory').className = 'pill ' + getRiskClass(j.dietary_category === 'è‘·é£Ÿ' ? 'high' : 'ok');
          el('dietaryReason').textContent = j.dietary_reason;
          el('overallSummary').textContent = j.overall_summary;

          // åˆ—è¡¨æ¸²æŸ“
          el('ingredients').innerHTML = j.ingredients.map(i => `<li>${i}</li>`).join('');
          el('allergens').innerHTML = j.allergens.map(i => `<li>${i}</li>`).join('');
          el('notes').innerHTML = j.notes.map(i => `<li>${i}</li>`).join('');

          // æ·»åŠ ç‰© (ä¿®æ­£é¡è‰²é‚è¼¯)
          el('additivesAlerts').innerHTML = j.additives_alerts.map(a => `
            <tr>
              <td><b>${a.name}</b></td>
              <td><span class="pill ${getRiskClass(a.risk_level)}">${a.risk_level}</span></td>
              <td>${a.description}</td>
            </tr>
          `).join('');

          // ç‡Ÿé¤Šå»ºè­°
          const n = j.nutrition_analysis;
          el('nutritionDetected').textContent = n.detected ? 'âœ… å·²è­˜åˆ¥' : 'âŒ æœªè­˜åˆ¥';
          el('caloriesPerServing').textContent = n.calories_per_serving;
          el('sodiumWarning').textContent = n.sodium_warning ? 'âš ï¸ åé«˜' : 'âœ… æ­£å¸¸';
          el('sodiumWarning').className = 'pill ' + (n.sodium_warning ? 'bad' : 'ok');
          el('sugarWarning').textContent = n.sugar_warning ? 'âš ï¸ åé«˜' : 'âœ… æ­£å¸¸';
          el('sugarWarning').className = 'pill ' + (n.sugar_warning ? 'bad' : 'ok');
          el('nutritionAdvice').textContent = n.advice;

          banner.innerHTML = '<span style="color:var(--success)">âœ… åˆ†æå®Œæˆ</span>';
        }
      } catch (e) {
        banner.innerHTML = '<span style="color:var(--danger)">âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡æˆ–ç¶²è·¯ã€‚</span>';
      } finally {
        btnAnalyze.disabled = false;
        btnAnalyze.textContent = 'é–‹å§‹åˆ†æ';
      }
    };
  </script>
</body>

</html>